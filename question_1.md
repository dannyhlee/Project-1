CREATE EXTERNAL TABLE PAGEVIEWS
(DOMAIN_CODE STRING,
PAGE_TITLE STRING,
COUNT_VIEWS INT,
TOTAL_RESPONSE_SIZE INT)
ROW FORMAT DELIMITED
FIELDS TERMINATED BY ' '
LOCATION '/user/dannylee/q1data';

DESCRIBE PAGEVIEWS;

# source files previously uploaded to ~/input for
# the hadoop solution to question 1

LOAD DATA INPATH '/user/dannylee/input' INTO TABLE PAGEVIEWS;

SELECT DISTINCT PAGE_TITLE, COUNT_VIEWS 
FROM PAGEVIEWS
WHERE DOMAIN_CODE = 'en'
ORDER BY COUNT_VIEWS DESC
LIMIT 100;

# Result: multiple lines and counts

# Try to Partition on the "en" value of DOMAIN_CODE
# to speed up processing time

CREATE TABLE EN_VIEWS
(PAGE_TITLE STRING,
COUNT_VIEWS INT,
TOTAL_RESPONSE_SIZE INT)
PARTITIONED BY (DOMAIN_CODE STRING)
ROW FORMAT DELIMITED
FIELDS TERMINATED BY ' '

INSERT INTO TABLE EN_VIEWS PARTITION(DOMAIN_CODE='en')
SELECT PAGE_TITLE, COUNT_VIEWS, TOTAL_RESPONSE_SIZE FROM PAGEVIEWS;

SELECT * FROM EN_VIEWS
ORDER BY COUNT_VIEWS DESC
LIMIT 20;
// results in duplications main page 20 times, ascending counts

SELECT DISTINCT * FROM EN_VIEWS
ORDER BY COUNT_VIEWS DESC
LIMIT 200;
// results in duplications like above

SELECT PAGE_TITLE, COUNT_VIEWS
FROM EN_VIEWS
GROUP BY PAGE_TITLE, COUNT_VIEWS
ORDER BY COUNT_VIEWS DESC
LIMIT 100;
// cleaner but still many duplicates...

// Redo, with John Rice's code

create table pageviews
(domain_code string,
article_name string,
total_views int,
response_size int)
row format delimited
fields terminated by ' ';

LOAD DATA INPATH '/home/dannylee/q1data' INTO TABLE PAGEVIEWS


SELECT DOMAIN_CODE, ARTICLE_NAME, SUM(TOTAL_VIEWS) AS TOTAL
FROM PAGEVIEWS
WHERE DOMAIN_CODE="en"
GROUP BY DOMAIN_CODE, ARTICLE_NAME
SORT BY TOTAL DESC
LIMIT 10;

